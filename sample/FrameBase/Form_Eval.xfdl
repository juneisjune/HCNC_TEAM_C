<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="Form_Eval" width="1280" height="720" titletext="New Form" onload="Form_Eval_onload">
    <Layouts>
      <Layout height="768" mobileorientation="landscape" width="1024" stepcount="0">
        <Static id="staTitle" taborder="0" text="직원 업무 평가 시스템" left="15" top="15" width="500" height="40" font="bold 20px/normal &quot;Arial&quot;" onclick="staTitle_onclick"/>
        <Button id="btnFilterSearch" taborder="3" text="검색" left="255" top="70" width="80" height="25" onclick="btnFilterSearch_onclick" cssclass="btn_search"/>
        <Grid id="grdEvaluation" taborder="7" left="15" top="160" width="992" height="550" binddataset="dsEvaluation" oncelldblclick="grdEvaluation_oncelldblclick">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="198"/>
                <Column size="198"/>
                <Column size="198"/>
                <Column size="198"/>
                <Column size="198"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="사번" expandsize="16"/>
                <Cell col="1" text="이름"/>
                <Cell col="2" text="평가일자"/>
                <Cell col="3" text="점수"/>
                <Cell col="4" text="등급"/>
              </Band>
              <Band id="body">
                <Cell text="bind:empCode" textAlign="center"/>
                <Cell col="1" text="bind:name" textAlign="center"/>
                <Cell col="2" text="bind:evalDate" textAlign="center"/>
                <Cell col="3" text="bind:totalScore" textAlign="center"/>
                <Cell col="4" text="bind:evalGrade" textAlign="center"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Combo id="cmbSearchType" taborder="1" text="전체" left="15" top="70" width="80" height="25" onitemchanged="dsEvaluation_onload" innerdataset="dsSearchType" value="all" index="0" codecolumn="CODE" datacolumn="CODE_NM"/>
        <Edit id="edtSearchText" taborder="2" left="105" top="70" width="140" height="25" onchanged="edtSearchText_onchanged"/>
        <Calendar id="calStartDate" taborder="4" left="15" top="110" width="110" height="25" onchanged="Calendar00_onchanged"/>
        <Calendar id="calEndDate" taborder="5" left="155" top="110" width="110" height="25" onchanged="calEndDate_onchanged"/>
        <Static id="Static00" taborder="8" text="~" left="135" top="110" width="30" height="30" font="bold 12px/normal &quot;Gulim&quot;"/>
        <Button id="btnReset" taborder="6" left="275" top="110" width="60" height="25" text="초기화" onclick="btnReset_onclick" cssclass="btn_normal"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="dsEvaluation" onload="dsEvaluation_onload">
        <ColumnInfo>
          <Column id="empCode" type="STRING" size="256"/>
          <Column id="name" type="STRING" size="256"/>
          <Column id="evalDate" type="DATE" size="256"/>
          <Column id="totalScore" type="INT" size="256"/>
          <Column id="evalGrade" type="STRING" size="256"/>
          <Column id="guideCode" type="STRING" size="256"/>
          <Column id="regName" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="dsSearchType">
        <ColumnInfo>
          <Column id="CODE" type="STRING" size="256"/>
          <Column id="CODE_NM" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="CODE">all</Col>
            <Col id="CODE_NM">전체</Col>
          </Row>
          <Row>
            <Col id="CODE">id</Col>
            <Col id="CODE_NM">ID</Col>
          </Row>
          <Row>
            <Col id="CODE">name</Col>
            <Col id="CODE_NM">이름</Col>
          </Row>
          <Row>
            <Col id="CODE">totalScore</Col>
            <Col id="CODE_NM">점수</Col>
          </Row>
          <Row>
            <Col id="CODE">grade</Col>
            <Col id="CODE_NM">등급</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="dsSearch">
        <ColumnInfo>
          <Column id="Type" type="STRING" size="256"/>
          <Column id="Word" type="STRING" size="256"/>
          <Column id="StartDate" type="STRING" size="256"/>
          <Column id="EndDate" type="STRING" size="256"/>
          <Column id="admin_code" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="Type"/>
            <Col id="Word"/>
          </Row>
        </Rows>
      </Dataset>
    </Objects>
    <InitValue/>
    <Bind>
      <BindItem id="item0" compid="grdEvaluation" propid="binddataset" datasetid="dsEvaluation" columnid=""/>
      <BindItem id="item1" compid="cmbSearchType" propid="value" datasetid="dsSearch" columnid="Type"/>
      <BindItem id="item2" compid="edtSearchText" propid="value" datasetid="dsSearch" columnid="Word"/>
      <BindItem id="item3" compid="calStartDate" propid="value" datasetid="dsSearch" columnid="StartDate"/>
      <BindItem id="item4" compid="calEndDate" propid="value" datasetid="dsSearch" columnid="EndDate"/>
    </Bind>
    <Script type="xscript5.1"><![CDATA[this.btnFilterSearch_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo) {
    this.fnSearch();
};

this.Form_Eval_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo) {
	
    this.dsSearch.setColumn(0, "Type", "all");
    this.fnSearch();
};


this.fnSearch = function() {

	var admin_code = nexacro.getApplication().ds_userInfo.getColumn(0, "emp_code");
	
	this.dsSearch.setColumn(0, "admin_code", admin_code);
	
    var searchType = this.dsSearch.getColumn(0, "Type");
    var searchWord = this.dsSearch.getColumn(0, "Word");
    var startDate = this.dsSearch.getColumn(0, "StartDate");
    var endDate = this.dsSearch.getColumn(0, "EndDate");
	
	// 시작 날짜와 끝 날짜 비교
	// Nexacro에서 YYYYMMDD 형식의 날짜일 경우, 이를 YYYY-MM-DD로 변환하는 함수
    function formatDateString(dateStr) {
        if (dateStr && dateStr.length === 8) {
            return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
        }
        return dateStr;  // 이미 적절한 형식인 경우 변환하지 않음
    }

    // 날짜 변환 후 비교
    startDate = formatDateString(startDate);
    endDate = formatDateString(endDate);

    if (startDate && endDate) {
        var start = new Date(startDate);
        var end = new Date(endDate);

        // 날짜가 유효한지 확인
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            alert("유효한 날짜 형식이 아닙니다.");
            return; // 검색 중단
        }

        // 시작 날짜가 끝 날짜보다 큰지 확인
        if (start > end) {
            alert("시작 날짜는 끝 날짜보다 앞서야 합니다.");
            return; // 검색 중단
        }
    }

    console.log("cmbSearchType = " + searchType);
    console.log("edtSearchText = " + searchWord);
    console.log("calStartDate = " + startDate);
    console.log("calEndDate = " + endDate);
    
    var strSvcID = "selectEval";
    var strSvcUrl = "svc::evallist.do";
    var inData = "dsSearch=dsSearch";
    var outData = "dsEvaluation=dsEvaluation";
    var strArg = "";
    var callBackFnc = "fnCallback";
    var isAsync = true;

    this.transaction(strSvcID, strSvcUrl, inData, outData, strArg, callBackFnc, isAsync);
};

this.btnReset_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo) {
    this.dsSearch.setColumn(0, "Type", "all");
    this.dsSearch.setColumn(0, "Word", "");
    this.dsSearch.setColumn(0, "StartDate", "");
    this.dsSearch.setColumn(0, "EndDate", "");
};

this.calEndDate_onchanged = function(obj:nexacro.Calendar,e:nexacro.ChangeEventInfo) {
};

this.grdEvaluation_oncelldblclick = function(obj:nexacro.Grid,e:nexacro.GridClickEventInfo)
{
	var objParam = {empCode:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "empCode")
                  , name:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "name")
                  , evalDate:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "evalDate")
				  , totalScore:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "totalScore")
				  , evalGrade:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "evalGrade")
				  , guideCode:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "guideCode")
				  , regName:this.dsEvaluation.getColumn(this.dsEvaluation.rowposition, "regName")};
				  
	this.showPopup(objParam);
};

this.showPopup = function(objParam)
{
	popup = new nexacro.ChildFrame;
	popup.init("popupEvalDetail", 0, 0, 780, 700, null, null, "FrameBase::Form_EvalDetail.xfdl");
	popup.set_dragmovetype("all");
	popup.set_layered("true");
	popup.set_autosize(true);
	popup.set_showtitlebar("Popup Title");
	popup.set_showstatusbar(false);
	popup.set_resizable(true);
	popup.set_openalign("center middle");
	popup.showModal(this.getOwnerFrame(), objParam, this, "fn_popupCallback", true);
	popup.style.set_overlaycolor("#6666664C");
	popup.form.style.set_border("1 solid #4c5a6f");
};
]]></Script>
  </Form>
</FDL>
